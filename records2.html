<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NHS EPR System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#f0f4f5; color:#0b0c0c; padding:20px; }
    .container { max-width:960px; margin:0 auto 40px; background:white; padding:30px; border-left:8px solid #005eb8; }
    h1,h2,h3{margin-top:0;}
    label{display:block; font-weight:bold; margin-bottom:4px;}
    input,textarea,select{width:100%; padding:10px; font-size:16px; border:1px solid #0b0c0c; border-radius:4px; box-sizing:border-box; margin-bottom:10px;}
    button{background:#005eb8;color:#fff;border:none;padding:10px 20px;font-size:16px;cursor:pointer;border-radius:4px;}
    button:hover{background:#003f7d;}
    table{width:100%; border-collapse:collapse; margin-bottom:20px;}
    th,td{padding:12px;text-align:left;border-bottom:1px solid #dfe3e6;}
    tr:hover{background:#f5f7fa;}
    a.patient-name{color:#005eb8;text-decoration:none;}
    a.patient-name:hover{text-decoration:underline;}
    .view{display:none;}
    .active{display:block;}
    .back-button{color:#005eb8;cursor:pointer;display:inline-block;margin-bottom:20px;}
    .admin-panel{margin-top:30px;}
  </style>
</head>
<body>
  <div class="container view active" id="loginView">
    <h1>NHS Patient Records – Sign In</h1>
    <label for="loginUsername">Username</label>
    <input id="loginUsername" type="text" required />
    <label for="loginPassword">Password</label>
    <input id="loginPassword" type="password" required />
    <button id="loginBtn">Sign in</button>
  </div>

  <div class="container view" id="mainView">
    <button id="logoutBtn" style="float:right;background:#c82333;">Logout</button>
    <h1>Patient Records</h1>

    <h2>Add New Patient</h2>
    <label for="name">Name</label><input id="name" type="text" required />
    <label for="age">Age</label><input id="age" type="number" min="0" required />
    <label for="gender">Gender</label><select id="gender" required><option value="">Select</option><option>Male</option><option>Female</option><option>Other</option></select>
    <label for="contact">Contact (phone/email)</label><input id="contact" type="text" required />
    <label for="condition">Medical Condition</label><textarea id="condition" rows="2" required></textarea>
    <button id="addPatientBtn">Add Patient</button>

    <h2>Patient List</h2>
    <table id="patientTable">
      <thead><tr><th>Name</th><th>Age</th><th>Gender</th><th>Contact</th><th>Condition</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>

    <div class="admin-panel" id="adminPanel">
      <h2>User Management (Admin)</h2>
      <label for="newUsername">New Username</label><input id="newUsername" type="text" required />
      <label for="newPassword">New Password</label><input id="newPassword" type="password" required />
      <button id="addUserBtn">Add User</button>

      <h3>Existing Users</h3>
      <table id="userTable"><thead><tr><th>Username</th><th>Role</th><th>Actions</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div class="container view" id="patientView">
    <span class="back-button" id="backBtn">← Back to list</span>
    <h1 id="patientName"></h1>
    <p><strong>Age:</strong> <span id="patientAge"></span></p>
    <p><strong>Gender:</strong> <span id="patientGender"></span></p>
    <p><strong>Contact:</strong> <span id="patientContact"></span></p>
    <p><strong>Condition:</strong> <span id="patientCondition"></span></p>

    <h2>Add Note</h2>
    <textarea id="entryText" rows="4" required></textarea>
    <button id="addEntryBtn">Save Note</button>

    <h2>Notes</h2>
    <ul id="notesList" style="padding-left:0;"></ul>
  </div>

  <script>
    // Users storage: password stored in plain text (NOT recommended in real apps)
    let users = JSON.parse(localStorage.getItem('users')) || [];

    // Initialize admin user if none exist
    if(users.length === 0){
      users = [{ username: 'CF', password: 'HiLLonden1!!', isAdmin: true }];
      localStorage.setItem('users', JSON.stringify(users));
    }

    let currentUser = null;
    let patients = JSON.parse(localStorage.getItem('patients')) || [];

    const views = {
      login: document.getElementById('loginView'),
      main: document.getElementById('mainView'),
      patient: document.getElementById('patientView')
    };

    function show(view){
      Object.values(views).forEach(v => v.classList.remove('active'));
      view.classList.add('active');
    }

    document.getElementById('loginBtn').onclick = () => {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      const user = users.find(u => u.username === username && u.password === password);
      if(user){
        currentUser = user;
        renderMain();
        show(views.main);
      } else {
        alert('Invalid username or password');
      }
    };

    document.getElementById('logoutBtn').onclick = () => {
      currentUser = null;
      show(views.login);
    };

    document.getElementById('addPatientBtn').onclick = () => {
      const name = document.getElementById('name').value.trim();
      const age = document.getElementById('age').value;
      const gender = document.getElementById('gender').value;
      const contact = document.getElementById('contact').value.trim();
      const condition = document.getElementById('condition').value.trim();
      if(name && age && gender && contact && condition){
        patients.push({name, age, gender, contact, condition, notes: []});
        savePatients();
        renderMain();
        clearPatientForm();
      } else {
        alert('Please fill all fields');
      }
    };

    function clearPatientForm(){
      ['name','age','gender','contact','condition'].forEach(id => document.getElementById(id).value = '');
    }

    function renderMain(){
      const tbody = document.querySelector('#patientTable tbody');
      tbody.innerHTML = '';
      patients.forEach((patient, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><a href="#" class="patient-name" data-index="${i}">${patient.name}</a></td>
          <td>${patient.age}</td>
          <td>${patient.gender}</td>
          <td>${patient.contact}</td>
          <td>${patient.condition}</td>
          <td>
            <button class="export" data-index="${i}">Export</button>
            <button class="delete" data-index="${i}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Patient name links
      document.querySelectorAll('.patient-name').forEach(link => {
        link.onclick = (e) => {
          e.preventDefault();
          viewPatient(link.dataset.index);
        };
      });

      // Delete buttons
      document.querySelectorAll('.delete').forEach(btn => {
        btn.onclick = () => {
          if(confirm('Are you sure you want to delete this patient?')){
            patients.splice(btn.dataset.index, 1);
            savePatients();
            renderMain();
          }
        };
      });

      // Export buttons
      document.querySelectorAll('.export').forEach(btn => {
        btn.onclick = () => exportPatient(btn.dataset.index);
      });

      // Show admin panel only if user is admin
      document.getElementById('adminPanel').style.display = currentUser.isAdmin ? 'block' : 'none';

      renderUsers();
    }

    function renderUsers(){
      const tbody = document.querySelector('#userTable tbody');
      tbody.innerHTML = '';
      users.forEach((user, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${user.username}</td>
          <td>${user.isAdmin ? 'Admin' : 'User'}</td>
          <td>${user.isAdmin ? '' : `<button class="deleteUser" data-index="${i}">Delete</button>`}</td>
        `;
        tbody.appendChild(tr);
      });

      document.querySelectorAll('.deleteUser').forEach(btn => {
        btn.onclick = () => {
          if(confirm(`Delete user ${users[btn.dataset.index].username}?`)){
            users.splice(btn.dataset.index, 1);
            localStorage.setItem('users', JSON.stringify(users));
            renderUsers();
          }
        };
      });
    }

    document.getElementById('addUserBtn').onclick = () => {
      const newUsername = document.getElementById('newUsername').value.trim();
      const newPassword = document.getElementById('newPassword').value;
      if(!newUsername || !newPassword){
        alert('Please enter username and password');
        return;
      }
      if(users.some(u => u.username === newUsername)){
        alert('Username already exists');
        return;
      }
      users.push({username: newUsername, password: newPassword, isAdmin: false});
      localStorage.setItem('users', JSON.stringify(users));
      renderUsers();
      document.getElementById('newUsername').value = '';
      document.getElementById('newPassword').value = '';
    };

    let currentPatient = null;

    function viewPatient(index){
      currentPatient = patients[index];
      document.getElementById('patientName').textContent = currentPatient.name;
      document.getElementById('patientAge').textContent = currentPatient.age;
      document.getElementById('patientGender').textContent = currentPatient.gender;
      document.getElementById('patientContact').textContent = currentPatient.contact;
      document.getElementById('patientCondition').textContent = currentPatient.condition;
      renderNotes();
      show(views.patient);
    }

    document.getElementById('backBtn').onclick = () => {
      show(views.main);
    };

    function renderNotes(){
      const ul = document.getElementById('notesList');
      ul.innerHTML = '';
      currentPatient.notes.forEach(note => {
        const li = document.createElement('li');
        li.textContent = note;
        li.style.background = '#f0f4f5';
        li.style.padding = '10px';
        li.style.marginBottom = '10px';
        li.style.borderRadius = '5px';
        ul.appendChild(li);
      });
    }

    document.getElementById('addEntryBtn').onclick = () => {
      const note = document.getElementById('entryText').value.trim();
      if(note){
        currentPatient.notes.push(note);
        savePatients();
        renderNotes();
        document.getElementById('entryText').value = '';
      } else {
        alert('Please enter a note');
      }
    };

    function exportPatient(index){
      const p = patients[index];
      const content = `**Patient Record**\nName: ${p.name}\nAge: ${p.age}\nGender: ${p.gender}\nContact: ${p.contact}\nCondition: ${p.condition}\nNotes:\n${p.notes.length ? p.notes.join('\n') : 'None'}`;
      const blob = new Blob([content], {type: 'text/plain'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${p.name.replace(/\s+/g, '_')}_record.txt`;
      a.click();
    }

    function savePatients(){
      localStorage.setItem('patients', JSON.stringify(patients));
    }
  </script>
</body>
</html>
